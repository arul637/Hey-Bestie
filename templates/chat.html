{% extends "base.html" %}
{% block title %}<title>FriendChat</title>{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<style>
  .input-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-top: 1px solid #ddd;
    display: flex;
    align-items: center;
    box-sizing: border-box;
    z-index: 2;
    justify-content: center;
  }

  .input-wrapper {
    display: flex;
    align-items: center;
    position: relative;
    width: 100%;
    max-width: 700px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 25px;
    padding: 5px 10px;
    gap: 10px;
  }

  #user_input {
    flex-grow: 1;
    padding: 10px 15px;
    border: none;
    font-size: 16px;
    border-radius: 25px;
    outline: none;
  }

  #send_button {
    background-color: #2ecc71;
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 18px;
    transition: background-color 0.3s ease;
  }

  #send_button:hover {
    background-color: #27ae60;
  }

  .emoji-toggle {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
  }

  .emoji-popup {
    display: none;
    position: absolute;
    bottom: 45px;
    left: 0;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px;
    font-size: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    gap: 8px;
    z-index: 10;
  }

  .emoji-popup span {
    cursor: pointer;
  }

  .emoji-popup span:hover {
    transform: scale(1.2);
  }

  .chatbot {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 6rem;
  }

  .message {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 15px;
    line-height: 1.4;
    font-size: 16px;
    word-wrap: break-word;
  }

  .message.user {
    align-self: flex-end;
    background-color: #dcf8c6;
    color: #333;
    border-bottom-right-radius: 0;
  }

  .message.bot {
    align-self: flex-start;
    background-color: #e6e6e6;
    color: #111;
    border-bottom-left-radius: 0;
  }

</style>
{% endblock %}

{% block body %}
<div class="chat-container">
  <div class="chat-header">
    <h2>Hey Bestie ü´Ç</h2>
  </div>

  <div class="chatbot" id="chat_display">
    <!-- Messages will be appended here -->
  </div>

  <div class="input-container">
    <div class="input-wrapper">
      <button type="button" class="emoji-toggle" id="emoji_btn" onclick="toggleEmojiPicker()">üòä</button>
      <input type="text" id="user_input" placeholder="Type your message..." onkeydown="checkEnter(event)">
      <button id="send_button" onclick="sendMessage()">‚û§</button>

      <!-- Emoji Picker -->
      <div class="emoji-popup" id="emoji_popup">
        <span onclick="insertEmoji('üëç')">üëç</span>
        <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="insertEmoji('üòî')">üòî</span>
        <span onclick="insertEmoji('üò≠')">üò≠</span>
        <span onclick="insertEmoji('üòÅ')">üòÅ</span>
        <span onclick="insertEmoji('üòÇ')">üòÇ</span>
        <span onclick="insertEmoji('üî•')">üî•</span>
        <span onclick="insertEmoji('üéâ')">üéâ</span>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Auto-greeting message
  window.onload = () => {
    const username = "{{ session.user.name }}";
    const chatDisplay = document.getElementById("chat_display");
    const botMessage = document.createElement("div");
    botMessage.classList.add("message", "bot");
    botMessage.innerText = `Hi ${username}! How can I help you today? üòä`;
    chatDisplay.appendChild(botMessage);
    chatDisplay.scrollTop = chatDisplay.scrollHeight;
  };

  // Send message on Enter
  function checkEnter(event) {
    if (event.key === "Enter") sendMessage();
  }

  // Insert emoji
  function insertEmoji(emoji) {
    const input = document.getElementById("user_input");
    input.value += emoji;
    input.focus();
    closeEmojiPopup();
  }

  // Toggle emoji picker
  function toggleEmojiPicker() {
    const popup = document.getElementById("emoji_popup");
    popup.style.display = popup.style.display === "flex" ? "none" : "flex";
  }

  // Close popup
  function closeEmojiPopup() {
    document.getElementById("emoji_popup").style.display = "none";
  }

  // Close popup if clicked outside
  document.addEventListener("click", function (event) {
    const popup = document.getElementById("emoji_popup");
    const emojiBtn = document.getElementById("emoji_btn");
    if (!popup.contains(event.target) && !emojiBtn.contains(event.target)) {
      closeEmojiPopup();
    }
  });

  // Send Message
  async function sendMessage() {
    const inputBox = document.getElementById("user_input");
    const userInput = inputBox.value.trim();
    if (!userInput) return;

    const chatDisplay = document.getElementById("chat_display");

    const userMessage = document.createElement("div");
    userMessage.classList.add("message", "user");
    userMessage.innerText = userInput;
    chatDisplay.appendChild(userMessage);
    chatDisplay.scrollTop = chatDisplay.scrollHeight;

    inputBox.value = "";

    const response = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: userInput })
    });

    const data = await response.json();

    const botMessage = document.createElement("div");
    botMessage.classList.add("message", "bot");
    botMessage.innerText = data.reply;
    chatDisplay.appendChild(botMessage);
    chatDisplay.scrollTop = chatDisplay.scrollHeight;
  }
</script>
{% endblock %}
